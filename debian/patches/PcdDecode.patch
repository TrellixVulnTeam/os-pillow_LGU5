From: Markus Koschany <apo@debian.org>
Date: Sun, 21 Feb 2016 15:56:33 +0100
Subject: PcdDecode

Fix buffer overflow in PcdDecode.c.

Origin: https://github.com/python-pillow/Pillow/commit/ae453aa18b66af54e7ff716f4ccb33adca60afd4
Debian-Bug: https://bugs.debian.org/813909
---
 Tests/test_file_pcd.py | 18 ++++++++++++++++++
 libImaging/PcdDecode.c |  4 ++--
 2 files changed, 20 insertions(+), 2 deletions(-)
 create mode 100644 Tests/test_file_pcd.py

diff --git a/Tests/test_file_pcd.py b/Tests/test_file_pcd.py
new file mode 100644
index 0000000..2401e70
--- /dev/null
+++ b/Tests/test_file_pcd.py
@@ -0,0 +1,18 @@
+from helper import unittest, PillowTestCase, hopper
+from PIL import Image
+
+class TestFilePcd(PillowTestCase):
+
+    def test_load_raw(self):
+        im = Image.open('Tests/images/hopper.pcd')
+        im.load() # should not segfault.
+
+        # Note that this image was created with a resized hopper
+        # image, which was then converted to pcd with imagemagick
+        # and the colors are wonky in Pillow.  It's unclear if this
+        # is a pillow or a convert issue, as other images not generated
+        # from convert look find on pillow and not imagemagick.
+        
+        #target = hopper().resize((768,512))
+        #self.assert_image_similar(im, target, 10)
+
diff --git a/libImaging/PcdDecode.c b/libImaging/PcdDecode.c
index fb6adc6..f923438 100644
--- a/libImaging/PcdDecode.c
+++ b/libImaging/PcdDecode.c
@@ -47,7 +47,7 @@ ImagingPcdDecode(Imaging im, ImagingCodecState state, UINT8* buf, int bytes)
 	    out[0] = ptr[x];
 	    out[1] = ptr[(x+4*state->xsize)/2];
 	    out[2] = ptr[(x+5*state->xsize)/2];
-	    out += 4;
+	    out += 3;
 	}
 
 	state->shuffle((UINT8*) im->image[state->y],
@@ -62,7 +62,7 @@ ImagingPcdDecode(Imaging im, ImagingCodecState state, UINT8* buf, int bytes)
 	    out[0] = ptr[x+state->xsize];
 	    out[1] = ptr[(x+4*state->xsize)/2];
 	    out[2] = ptr[(x+5*state->xsize)/2];
-	    out += 4;
+	    out += 3;
 	}
 
 	state->shuffle((UINT8*) im->image[state->y],
